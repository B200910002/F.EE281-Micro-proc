#include <avr/io.h>	 	 // AtMega128-??? ?????? ???
#include <avr/interrupt.h>		 // Atmega128-??? ????????? ???
#define F_CPU 16000000UL
#include <util/delay.h>
#define IDLE 	 0	 	 	 // IDLE ??????? ????
#define GO 	 1	 	 	 // GO ??????? ????
#define STOP	 2	 	 	 // STOP ??????? ????
volatile int cur_time=9999;	 	 // cur_time ??????????? ????? ????
volatile int stop_time=9999;	 	 // stop_time ??????????? ????? ????
volatile int state=IDLE;	 	 // ????? ????? IDLE
// FND -? ??????? ??????? ??????
unsigned char digit[10]={0x3f,0x06,0x5b,0x4f,0x66,
0x6d,0x7d,0x07,0x7f,0x6f};
// FND ????? ?????? ??????
unsigned char fond_sel[4]={0x01,0x02,0x04,0x08};

void init_stopwatch(void);	 //?????? ??????? ?????????? ?????
// ?????? ??????????? ???? ??????????
void display_fnd(int);
int main(void)
{
	init_stopwatch();
	while (1)
	{
		if (state==IDLE)		 	 // IDLE ?????? ??????
		{
			display_fnd(stop_time);	 // ????? ???? 00.00, ??? ???????????
		}
		else
		{
			if (state==STOP)	 	 // STOP ?????? ??????
			{
				display_fnd(stop_time);	 	 // SW2 ????????? ????? ????
			}
			else		 	 	 	 // GO ?????? ?????? ???
			{
				display_fnd(cur_time);	 	 // ???????? ?????? ????????.
				cur_time--;	 	 	 // ??? ?????????? ?????.
			}
		}
		if (cur_time==0)	 	 	 // 99.99-??? ????????? ????
		{	 	 	 	 	 // 00.00 ?????.
			char tel_num[16]={0x00, 0x00, 0x00, 0x00,
				0x76, 0x79,0x38,0x73,0x00,
				0x33,0x27, 0x79,
			0x00, 0x00, 0x00,0x00};
			int i,j;
			DDRC=0xff; //FND ???????? C ?????? ?????? ?????? ???????.
			DDRG=0x0f; //FND-??? ????? ?????? G ?????? ?????? ???????.
			while (1)
			{
				for(i=0; i<13; i++)
				{
					for(j=0; j<50; j++)
					{
						PORTC=tel_num[i]; PORTG=0x08; _delay_ms(1);
						PORTC=tel_num[i+1]; PORTG=0x04; _delay_ms(1);
						PORTC=tel_num[i+2]; PORTG=0x02; _delay_ms(1);
						PORTC=tel_num[i+3]; PORTG=0x01; _delay_ms(1);
					}
				}
			}
		}
	}
}
void init_stopwatch(void)
{
	DDRC=0xff;	 	 	 // LED output
	DDRG=0x0f;	 	 	 // segment common output
	DDRE=0x00;	 	 	 // interrupt input
	SREG |=0x80;	 	 	 // Global Interrupt Enable=1;
	EIMSK=0x30;	 	 	 // INT4, INT5 enabled
	EICRB=0x0a;	 	 	 // interrupt trigger mode LOW
}
void display_fnd(int count_data)	 	 //FND ??? ??????? ?????
// ??? ???????? ??? ????
// ?????? ??????? 10ms ?????
{
	int i, num[4];	 	 	 	 // ?? ???????? ???????? ??????
	// ??????? ?????.
	// ????? ??? ???????? ???
	// ??????? ???????? ?????????
	// ?????? ?????.
	num[3]=(count_data/1000)%10;	 	 // ???????? ????
	num[2]=(count_data/100)%10;	 	 // ?????? ????
	num[1]=(count_data/10)%10;	 	 // ??????? ????
	num[0]=count_data%10;	 	 // ??????? ????
	for (i=0;i<4;i++)	 	 	 	 // ?????? ???? ?????????????
	// ??????? ???????
	// ?????????? ?????.
	{
		// 		if (i==2)
		// 		PORTC=digit[num[i]] | 0x80;	 // ????? ???? ???? ??? ????
		// 		// 2???? ??????? ????????.
		// 		else
		PORTC=digit[num[i]];	 	 // ????? ???? ?????? ?????
		// ???? ????????.
		PORTG=fond_sel[i];	 	 	 // FND ???? ??????
		if (i%2)
		_delay_ms(2);	 	 // ??????? ???? 2ms
		else 	 _delay_ms(3);	 	 // ???? ???? 3ms
	}	 	 	 	 // 4-? ?????????? ???? 10ms ???????.
}
ISR(INT4_vect)	 	 // INT4-??? ISR ?????
{
	_delay_ms(20);	 	 // ?????? ????? ???????.
	// ??? ??????? ????????? ?????? ????????
	// ???????? ?????.
	EIFR|=1<<4;
	if ((PINE&0x10)==0x10)	 // ????????? ??????? ????? ???????
	{
		return;	 	 // SW1 ??????????? ??? ???????? ????????.
	}
	if (state==IDLE || state==STOP) // IDLE ????? STOP ?????? ???? ???
	{
		state=GO;	 	 	 // ??????? GO ?????
	}
	else	 	 	 	 // GO ?????? ?????? ???
	{
		state=STOP;	 	 	 // ??????? STOP ?????
		stop_time=cur_time;	 	 // ??????? ??????? ?? ???????? ???????
	}
}
ISR(INT5_vect)	 	 // INT5-??? ISR ?????
{
	_delay_ms(20);	 	 // ?????? ????? ???????.
	// ??? ??????? ????????? ?????? ????????
	// ???????? ?????.
	EIFR|=1<<5;
	if ((PINE&0x20)==0x20)	 // ????????? ??????? ????? ???????
	{
		return;	 	 // SW2 ??????????? ??? ???????? ????????.
	}
	state=IDLE;	 	 // ??????? IDLE ?????
	stop_time=99;	 	 // ?????? ???????? ?????????.
	cur_time=99;	 	 // ???????? ???????? ?????????.
}


#include <avr/io.h>	 	 // AtMega128-??? ?????? ???
#include <avr/interrupt.h>
#include <avr/common.h>	 // Atmega128
#define F_CPU 16000000UL
#include <util/delay.h>
#define IDLE 	 0	 	 	 // IDLE ??????? ????
#define GO 	 1	 	 	 // GO ??????? ????
#define STOP	 2 	 // GO ??????? ????
#define BACK	 3	 	 	 // STOP ??????? ????
volatile int cur_time=0;
volatile int cur_time1=100;
volatile int stop_time=0;	 	 // stop_time ??????????? ????? ????
volatile int state=IDLE;
volatile int state1=GO;	 	 // ????? ????? IDLE
// ????? ????? IDLE
// FND -? ??????? ??????? ??????
unsigned char digit[10]={0x3f,0x06,0x5b,0x4f,0x66,
0x6d,0x7d,0x07,0x7f,0x6f};
// FND ????? ?????? ??????
unsigned char fond_sel[4]={0x01,0x02,0x04,0x08};

void init_stopwatch(void);	 //?????? ??????? ?????????? ?????
// ?????? ??????????? ???? ??????????
void display_fnd(int);
int main(void)
{
	init_stopwatch();
	while (1)
	{
		if (state==IDLE)		 	 // IDLE ?????? ??????
		{
			if(cur_time < 0){
				display_fnd(cur_time1);
			}
			else{
				display_fnd(cur_time);
			}
		}
		else
		{
			if(state == BACK){
				
				if(cur_time < 0){
					display_fnd(cur_time1);
					cur_time1++;
				}
				else if(cur_time == 0){
					cur_time--;
				}
				else {
					display_fnd(cur_time);
				}
				cur_time--;
			}
			else
			{
				if(cur_time < 0){
					display_fnd(cur_time1);
					cur_time1--;
				}
				else if(cur_time == 0){
					cur_time ++;
				}
				else {
					display_fnd(cur_time);
				}
				cur_time++;
			}
		}
		if (cur_time==2300)	 	 	 // 99.99-??? ????????? ????
		{
			state = BACK;  	 // 00.00 ?????.
		}
		else if (cur_time==-300)	 	 	 // 99.99-??? ????????? ????
		{
			state = GO;
		}
	}
}
void init_stopwatch(void)
{
	DDRC=0xff;	 	 	 // LED output
	DDRG=0x0f;	 	 	 // segment common output
	DDRE=0x00;	 	 	 // interrupt input
	SREG |=0x80;	 	 	 // Global Interrupt Enable=1;
	EIMSK=0x30;	 	 	 // INT4, INT5 enabled
	EICRB=0x0a;	 	 	 // interrupt trigger mode LOW
}
void display_fnd(int count_data)
{
	int i, num[4];
	num[1]=(count_data/1000)%10;
	num[0]=(count_data/100)%10;
	if(cur_time < 0){
		for (i=0;i<2;i++)
		{
			if(i == 1){
				PORTC=0x40;
			}
			else{
				PORTC=digit[num[0]];
			}
			PORTG=fond_sel[i+1];
			if (i%2)
			_delay_ms(2);
			else 	 _delay_ms(3);
		}
		}else{
		for (i=0;i<2;i++)
		{
			PORTC=digit[num[i]];
			PORTG=fond_sel[i+1];
			if (i%2)
			_delay_ms(2);
			else 	 _delay_ms(3);
		}
	}
	
}
ISR(INT4_vect)
{
	_delay_ms(20);
	EIFR|=1<<4;
	if ((PINE&0x10)==0x10)
	{
		return;
	}
	if (state==GO)
	{
		state = BACK;
	}
	else if(state ==BACK)
	{
		state=GO;
	}
}
ISR(INT5_vect)
{
	_delay_ms(20);
	EIFR|=1<<5;
	if ((PINE&0x20)==0x20)
	{
		return;
	}
	if (state==GO || state== BACK)
	{
		state1 = state;
		state=IDLE;
	}
	else
	{
		state=state1;
	}
	
}